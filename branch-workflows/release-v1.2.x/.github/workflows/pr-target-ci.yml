# v1.2.x Branch Workflow
# This workflow is INTENTIONALLY DIFFERENT from main
# It represents the CI configuration frozen at v1.2.x release time
#
# KEY DIFFERENCES FROM MAIN:
# - Uses Node.js 18 (not 20 like main)
# - Introduced security scanning (not in v1.1)
# - Uses Jest 28 (upgraded from v1.1)
# - Different container naming scheme

name: PR Target CI (v1.2.x)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Security scan (introduced in v1.2)
        run: |
          echo "=== v1.2.x Security Scanning ==="
          echo "This security scan was INTRODUCED in v1.2.x"
          echo "It uses v1.2.x security rules and thresholds"
          echo ""
          echo "Scanning for vulnerabilities..."
          sleep 1
          echo "Security scan passed (v1.2.x rules)"

  build-and-test:
    needs: security-scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js (v1.2.x uses Node 18)
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Frozen at Node 18 for v1.2.x compatibility

      - name: v1.2.x specific configuration
        run: |
          echo "=== v1.2.x Branch CI ==="
          echo "This workflow is SPECIFIC to the v1.2.x branch"
          echo ""
          echo "Configuration frozen at v1.2.x release:"
          echo "- Node.js: 18 (LTS at v1.2 release time)"
          echo "- Test framework: Jest 28"
          echo "- Security scanning: enabled (new in v1.2)"
          echo "- Container registry: v2 API"
          echo ""
          echo "This workflow SHOULD run when PRs target release/v1.2.x"
          echo "But due to pull_request_target changes, the workflow from main runs instead"

      - name: Build container (v1.2 style)
        run: |
          echo "Building with v1.2.x Dockerfile..."
          echo "Using v1.2 build optimizations..."
          # Would use: docker build -f Dockerfile.v1.2 .

      - name: Run tests
        run: |
          echo "Running Jest 28 test suite..."
          echo "Using v1.2.x test configuration..."
          sleep 2
          echo "Tests passed (v1.2.x style)"

      - name: Push to registry
        run: |
          echo "Pushing to registry with v1.2.x naming convention..."
          echo "Image: myorg/app:v1.2.x-pr-${{ github.event.pull_request.number }}"
